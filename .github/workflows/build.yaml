name: CI - Build and Push Docker Image

# 1. Define when this workflow should run
on:
  push:
    branches:
      - main # Run whenever code is pushed to the 'main' branch

jobs:
  # 2. Define the main build and push job
  build-and-push:
    runs-on: ubuntu-latest # Use a fresh Linux virtual machine provided by GitHub
    permissions:
      contents: read # To checkout the code
      packages: write # To push images to GitHub Packages

    env:
      IMAGE_NAME: devops-starter-projects # Define a clean image name
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 # Get the latest code from the repository

      # 3. Log in to the GitHub Container Registry (GHCR)
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }} # GITHUB_TOKEN is automatically created

      # 4. Build and Push the Docker image to GHCR
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true # Push the image after building
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          
      # 5. A better smoke test: Run the container and check if it's serving content
      - name: Run Smoke Test
        run: |
          echo "Running container from the built image..."
          # Note: We use the local tag for the smoke test
          docker run --name my-test-app -d -p 8080:80 ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
          echo "Waiting for container to start..."
          sleep 5
          echo "Testing web server response..."
          curl -f http://localhost:8080

      # 6. Conceptual output for successful completion
      - name: CI/CD Success Message
        run: |
          echo "==================================================="
          echo "CI/CD Pipeline Successful! Image pushed to GHCR."
          echo "Image URL: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "==================================================="